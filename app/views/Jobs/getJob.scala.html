@(fwkJob: org.daisy.pipeline.client.models.Job, uiJob: models.Job)

@main("View job", "", Array("notifications.js","fuzzyDates.js")) {

<script type="text/javascript" charset="utf-8">
$(function(){Notifications.init("@{routes.Notifications.websocket(Long.parseLong(flash().get("browserId"))).webSocketURL(request)}", "@{routes.Notifications.xhr(Long.parseLong(flash().get("browserId"))).absoluteURL(request)}");});
</script>

<hgroup>
	<h1>Job Summary<br>
	<small>@uiJob.nicename</small></h1>
	
	<small><a class="accordion-toggle collapsed" data-toggle="collapse" href="#job-details">
		<style>
			#job-details-show { display:none; }
			.collapsed #job-details-show { display:inline; }
			#job-details-hide { display:inline; }
			.collapsed #job-details-hide { display:none; }
		</style>
		<span id="job-details-show"><i class="icon-chevron-down"></i>Show details</span>
		<span id="job-details-hide"><i class="icon-chevron-up"></i>Hide details</span>
	</a></small>

</hgroup>

<div class="collapse" id="job-details">
	<style>
		/*#job-details td { vertical-align: middle; }*/
	</style>
	<table class="table table-hover table-condensed">
		<tr>
			<td><strong>Job:</strong></td>
			<td>
				<strong>@uiJob.nicename</strong><br/>
				<small class="muted">@fwkJob.id</small>
			</td>
		</tr>
		<tr>
			<td>Script:</td>
			<td>
				@uiJob.scriptName<br/>
				<small class="muted">@uiJob.scriptId</small>
			</td>
		</tr>
		<tr>
			<td>Created:</td>
			<td>
				<span id="created-fuzzy" aria-live="timer"></span><br/>
				<small class="muted" id="created">@uiJob.created</small>
				<script type="text/javascript">$(function(){updateFuzzy("created-fuzzy",new Date(@if(uiJob.created==null){ 0 }else{ @uiJob.created.getTime() } ));});</script>
			</td>
		</tr>
		<tr>
			<td>Started:</td>
			<td>
				<span id="started-fuzzy" aria-live="timer"></span><br/>
				<small class="muted" id="started">@uiJob.started</small>
				<script type="text/javascript">$(function(){updateFuzzy("started-fuzzy",new Date(@if(uiJob.started==null){ 0 }else{ @uiJob.started.getTime() } ));});</script>
			</td>
		</tr>
		<tr>
			<td>Finished:</td>
			<td>
				<span id="finished-fuzzy" aria-live="timer"></span><br/>
				<small class="muted" id="finished">@uiJob.finished</small>
				<script type="text/javascript">$(function(){updateFuzzy("finished-fuzzy",new Date(@if(uiJob.finished==null){ 0 }else{ @uiJob.finished.getTime() } ));});</script>
			</td>
		</tr>
	</table>
	<br/>
</div>

<div class="row">
	<div class="hero-unit" style="text-align:center">
	
	<div id="status-done" style="display:none;">
		<h2 role="status" class="text-success">Success</h1>
		<a class="btn btn-large btn-success" href="@routes.Jobs.getResult(fwkJob.id)"><i class="icon-download-alt icon-white"></i> Download results</a>
	</div>
	
	<div id="status-running" style="display:none;">
		<h2 role="status" class="text-info">
			Running
			<span aria-live="none">
				<span id="runningDot1"                       >&nbsp;.&nbsp; &nbsp; &nbsp;</span>
				<span id="runningDot2" style="display: none;">&nbsp;.&nbsp;.&nbsp; &nbsp;</span>
				<span id="runningDot3" style="display: none;">&nbsp;.&nbsp;.&nbsp;.&nbsp;</span>
				<script type="text/javascript">
					window.setInterval(function(){
						if ($("#runningDot1").is(":visible")) {
							$("#runningDot1").hide();
							$("#runningDot2").show();
							
						} else if ($("#runningDot2").is(":visible")) {
							$("#runningDot2").hide();
							$("#runningDot3").show();
							
						} else {
							$("#runningDot3").hide();
							$("#runningDot1").show();
						}
					},1000);
				</script>
			</span>
		</h2>
		<br/>
		@if(fwkJob.messages.size()>0){
			<ul style="list-style-type:none;text-align:left;padding-top:20px;"><li id="message-latest"><pre>@fwkJob.messages.get(fwkJob.messages.size()-1).text</pre></li></ul>
		} else {
			<ul style="list-style-type:none;text-align:left;padding-top:20px;"><li id="message-latest"><pre>&nbsp;</pre></li></ul>
		}
	</div>
	
	<div id="status-idle" style="display:none;">
		<h2 role="status" class="text-muted">Queued</h2>
		@if(fwkJob.messages.size()>0){
			<ol start="@fwkJob.messages.get(fwkJob.messages.size()-1).sequence"><li><pre>@fwkJob.messages.get(fwkJob.messages.size()-1).text</pre></li></ol>
		}
	</div>
	
	<div id="status-error" style="display:none;">
		<h2 role="status" class="text-error">Failed</h2>
		<p>See the message log for details.</p>
	</div>
	
	<script type="text/javascript">
		$("#status-@(fwkJob.status.toString().toLowerCase())").show();
	</script>
	
	</div>
</div>

<h2>Execution Log</h2>

<br/>
<a class="btn btn-info" href="@routes.Jobs.getLog(fwkJob.id)"><i class="icon-download-alt icon-white"></i> Download Detailed Log</a>
<br/><br/>

<ol aria-live="polite" role="log" class="messagelist" id="message-list">
	@for(message <- fwkJob.messages){
		<li value="@message.sequence"><span class="message @("text-error".when(org.daisy.pipeline.client.models.job.Message.Level.ERROR==message.level)) @("text-warning".when(org.daisy.pipeline.client.models.job.Message.Level.WARNING==message.level))"">@message.text</span></li>
	}
</ol>

<br/><br/><br/>

<script type="text/javascript">
	$(function(){
		Notifications.listen("job-message-@fwkJob.id", function(message){
			//if ($("#message-list li").filter(function(i){return $(this).attr("value")===message.sequence;}).size() === 0) {
				$("#message-list").append('<li value="'+message.sequence+'"><span class="message '+(message.level=="ERROR"?"message-error":"")+(message.level=="WARNING"?"message-warn":"")+'">'+message.text+'</span></li>');
				$("#message-latest").html("<pre>"+message.text+"</pre>");
			//}
		});
		Notifications.listen("job-status-@fwkJob.id", function(status){
			@for(status <- org.daisy.pipeline.client.models.Job.Status.values()){
				$("#status-@(status.toString().toLowerCase())").hide();
			}
			$("#status-"+status.toLowerCase()).show();
		});
		Notifications.listen("job-started-@fwkJob.id", function(message){ $("#started").html(message.text); updateFuzzy("started-fuzzy", new Date(parseInt(message.number))); });
		Notifications.listen("job-finished-@fwkJob.id", function(message){ $("#finished").html(message.text); updateFuzzy("finished-fuzzy", new Date(parseInt(message.number))); });
	});
</script>

}