@(frameworkState: String)

@main("Scripts", "scripts", Array("notifications.js"), Array()){

<script type="text/javascript" charset="utf-8">
$(function(){Notifications.init("@{routes.Notifications.websocket(Long.parseLong(flash().get("browserId"))).webSocketURL(request)}", "@{routes.Notifications.xhr(Long.parseLong(flash().get("browserId"))).absoluteURL(request)}");});
</script>

<hgroup>
<h1>Create Job</h1>
</hgroup>

<div class="INITIAL" style="text-align:center;display:none;">
	<img src="@routes.Assets.at("images/loading.gif")" alt="" style="margin:10px;"/><br/>
	<span>Loading...</span>
</div>
<div class="RUNNING" style="display:none;">
	<table id="scriptTable" class="oneOrMoreScripts table scriptlist" style="display:none;">
		<tbody>
			<tr>
				<th>Script</th>
				<th>Description</th>
			</tr>
		</tbody>
	</table>
	<div role="alert" class="noScripts alert alert-info" style="display:none;">
		<p>There are no scripts installed.</p>
	</div>
</div>
<div role="alert" class="STARTING alert alert-info" style="text-align:center; display:none;">
	<img src="@routes.Assets.at("images/loading.gif")" alt="" style="margin:10px;"/>
	<p>Starting the Pipeline engine...</p>
</div>
<div class="STOPPED" style="display:none;">
	<p style="text-align:center;">
		<img src="@routes.Assets.at("images/loading.gif")" alt="" style="margin:10px;"/><br/>
		<span>Attempting to connect to the framework...</span>
	</p>
	<br/>
	<div role="alert" class="alert alert-warning">
		<p>Unable to communicate with the Pipeline engine.</p>
		<p>Please check the configuration of the Pipeline 2 engine in the administrative settings.</p>
	</div>
</div>

<script type="text/javascript">
	$(function(){
		var updateState = function (state){
			$(".INITIAL").hide();
			if (state === "RUNNING") {
				$(".STOPPED").hide();
				$(".STARTING").hide();
				$(".RUNNING").show();
			} else if (state === "STARTING") {
				$(".STOPPED").hide();
				$(".STARTING").show();
				$(".RUNNING").hide();
			} else if (state === "STOPPED") {
				$(".STOPPED").show();
				$(".STARTING").hide();
				$(".RUNNING").hide();
			}
		}
		Notifications.listen("heartbeat", updateState);
		var scriptHrefBase = "@routes.Scripts.getScript("")";
		var checkForScripts = function() {
			$.ajax({
				url: "@routes.Scripts.getScriptsJson()",
				error: function(jqXHR, textStatus, errorThrown) {
					//$(".INITIAL").hide();
					//$(".ERROR").hide();
					setTimeout(checkForScripts,5000);
				},
				success: function(scripts, textStatus, jqXHR) {
					$(".INITIAL").hide();
					$(".STOPPED").hide();
					$(".STARTING").hide();
					$(".RUNNING").show();
					if (scripts.length === 0) {
						$(".oneOrMoreScripts").hide();
						$(".noScripts").show();
					}
					else {
						$(".oneOrMoreScripts").show();
						$(".noScripts").hide();
						var table = $("#scriptTable tbody");
						for (var s = 0; s < scripts.length; s++) {
							$(table).append(
								"	<tr>\n"+
								"		<td><a href=\"@routes.Scripts.getScript("")"+scripts[s].id+"\">"+scripts[s].nicename+"</td>\n"+
								"		<td>"+scripts[s].desc+"</td>\n"+
								"	</tr>\n");
						}
					}
				}
			});
		}
		checkForScripts();
		setTimeout(function(){
			// show spinning gif after one second of waiting
			if (!$(".STOPPED, .STARTING, .RUNNING, .ERROR").is(":visible")) {
				$(".INITIAL").show();
			}
		},1000);
		updateState("@frameworkState");
	});
</script>


}
